{% extends "base.html" %}

{% block title %}Detalle del Producto - Ecommerce Store{% endblock %}

{% block extra_head %}
<script src="/static/ecomerce/cart_button.js"></script>
{% endblock %}

{% block extra_styles %}
        :root {
            --ecommerce-blue: #00bfff;
            --ecommerce-dark: #1a1a1a;
            --ecommerce-gray: #f8f9fa;
            --ecommerce-light: #ffffff;
            --ecommerce-text: #333333;
            --ecommerce-text-light: #666666;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--ecommerce-gray);
            color: var(--ecommerce-text);
            line-height: 1.6;
        }
        .product-image {
            max-width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: 12px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--ecommerce-blue) 0%, #0099cc 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 191, 255, 0.3);
        }
        .btn-secondary {
            background: var(--ecommerce-light);
            color: var(--ecommerce-blue);
            border: 2px solid var(--ecommerce-blue);
            border-radius: 12px;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        .btn-secondary:hover {
            background: var(--ecommerce-blue);
            color: white;
        }
        .quantity-input {
            width: 80px;
            text-align: center;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.5rem;
            font-size: 1rem;
        }
        /* Cart Sidebar */
        .cart-sidebar {
            background: var(--ecommerce-light);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
        }
        .cart-overlay {
            background: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }
        /* ANIMACIONES DE VARIANTES */
        .variant-option {
            transition: all 0.3s ease;
        }
        .variant-option:hover {
            transform: translateY(-2px);
        }
        .variant-select {
            transition: all 0.3s ease;
            border-color: var(--ecommerce-text-light);
        }
        .variant-select:focus {
            border-color: var(--ecommerce-blue);
            box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.1);
        }
        .price-update {
            animation: priceFlip 0.4s ease-in-out;
        }
        @keyframes priceFlip {
            0% {
                opacity: 0;
                transform: rotateX(-90deg);
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 1;
                transform: rotateX(0deg);
            }
        }
        .variant-change-highlight {
            animation: highlight 0.6s ease-in-out;
        }
        @keyframes highlight {
            0% {
                background-color: rgba(0, 191, 255, 0.2);
            }
            100% {
                background-color: transparent;
            }
        }
{% endblock %}

{% block content %}
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Product Image -->
            <div>
                <img id="product-image" src="/static/img/logo.png" alt="Producto" class="product-image w-full">
            </div>

            <!-- Product Info -->
            <div class="space-y-6">
                <div>
                    <h1 id="product-name" class="text-3xl font-bold text-gray-900">Cargando producto...</h1>
                    <p id="product-description" class="text-gray-600 mt-2">Descripci√≥n del producto</p>
                </div>

                <div>
                    <p class="text-3xl font-bold text-blue-600" id="product-price">$0.00</p>
                    <p class="text-sm text-gray-500" id="product-stock">Stock disponible</p>
                </div>

                <!-- Add to Cart -->
                <div class="space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="text-gray-700 font-medium">Cantidad:</label>
                        <input type="number" id="quantity" value="1" min="1" class="quantity-input">
                    </div>

                    <!-- Variantes del Producto -->
                    <div id="variants-container" class="hidden bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-layer-group mr-2 text-blue-600"></i>
                            Opciones disponibles
                        </h3>
                        <div id="variants-list" class="space-y-4">
                            <!-- Las variantes se cargar√°n aqu√≠ -->
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button id="add-to-cart-btn" class="btn-primary flex-1">
                            <i class="fas fa-cart-plus"></i>
                            Agregar al Carrito
                        </button>
                        <button id="wishlist-btn" class="bg-white text-gray-600 hover:text-red-500 border-2 border-gray-300 hover:border-red-500 rounded-lg px-6 py-3 transition-all duration-200 flex items-center justify-center" title="Agregar a favoritos">
                            <i class="far fa-heart text-2xl"></i>
                        </button>
                    </div>
                    <a href="/ecomerce/productos/tienda" class="btn-secondary w-full justify-center">
                        <i class="fas fa-arrow-left"></i>
                        Volver a la Tienda
                    </a>
                </div>

                <!-- Product Details -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4">Detalles del Producto</h3>
                    <div class="space-y-2">
                        <p><strong>C√≥digo:</strong> <span id="product-code">-</span></p>
                        <p><strong>Categor√≠a:</strong> <span id="product-category">-</span></p>
                        <p><strong>Estado:</strong> <span id="product-active">-</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="mt-12 bg-white p-6 rounded-lg shadow">
            <h3 class="text-xl font-semibold mb-6">Rese√±as de Clientes</h3>
            <div id="reviews-container">
                <p class="text-gray-600">Cargando rese√±as...</p>
            </div>
        </div>

        <!-- Loading/Error Messages -->
        <div id="loading" class="text-center py-8 hidden">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            <p class="mt-2 text-gray-600">Cargando producto...</p>
        </div>

        <div id="error" class="text-center py-8 bg-red-50 border border-red-200 rounded-lg hidden">
            <p class="text-red-600">Error al cargar el producto. Por favor, intenta nuevamente.</p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <p>&copy; 2025 Tienda Online. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
        // Get product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = window.location.pathname.split('/').pop();
        
        // Variable global para almacenar los datos del producto
        let currentProduct = null;

        // Initialize the product detail page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Product detail page loaded for product:', productId);
            loadProductDetails(productId);
            loadProductReviews(productId);
            checkWishlistStatus();
        });

        async function checkWishlistStatus() {
            // Obtener token desde authManager o storage
            let token = null;
            if (window.authManager && typeof window.authManager.getToken === 'function') {
                token = window.authManager.getToken();
            }
            if (!token) {
                token = sessionStorage.getItem('ecommerce_token') ||
                       localStorage.getItem('token') ||
                       localStorage.getItem('access_token');
            }
            if (!token) return;

            try {
                // Obtener toda la lista de deseos
                const response = await fetch('/ecomerce/api/lista-deseos/', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const wishlistProductIds = new Set(
                        (data.productos || []).map(item => item.producto?.id || item.id_producto)
                    );
                    const inWishlist = wishlistProductIds.has(productId);
                    updateWishlistButton(inWishlist);
                }
                // Si falla, simplemente no actualizar el bot√≥n
            } catch (error) {
                // Error de red - ignorar silenciosamente
            }
        }

        function updateWishlistButton(inWishlist) {
            const button = document.getElementById('wishlist-btn');
            const icon = button.querySelector('i');
            
            // Agregar animaci√≥n de rebote
            button.style.transition = 'transform 0.2s ease';
            button.style.transform = 'scale(1.15)';
            setTimeout(() => {
                button.style.transform = 'scale(1)';
            }, 200);
            
            if (inWishlist) {
                button.classList.add('in-wishlist');
                button.classList.remove('text-gray-600', 'border-gray-300');
                button.classList.add('text-red-500', 'border-red-500', 'bg-red-50');
                icon.classList.remove('far');
                icon.classList.add('fas');
                button.setAttribute('title', 'Remover de favoritos');
            } else {
                button.classList.remove('in-wishlist', 'text-red-500', 'border-red-500', 'bg-red-50');
                button.classList.add('text-gray-600', 'border-gray-300');
                icon.classList.remove('fas');
                icon.classList.add('far');
                button.setAttribute('title', 'Agregar a favoritos');
            }
        }

        async function toggleWishlist() {
            // Obtener token desde authManager o storage
            let token = null;
            if (window.authManager && typeof window.authManager.getToken === 'function') {
                token = window.authManager.getToken();
            }
            if (!token) {
                token = sessionStorage.getItem('ecommerce_token') ||
                       localStorage.getItem('token') ||
                       localStorage.getItem('access_token');
            }
            
            if (!token) {
                alert('Debes iniciar sesi√≥n para agregar favoritos');
                window.location.href = '/ecomerce/login?redirect=' + encodeURIComponent(window.location.pathname);
                return;
            }

            const button = document.getElementById('wishlist-btn');
            const isInWishlist = button.classList.contains('in-wishlist');
            
            try {
                if (isInWishlist) {
                    const response = await fetch(`/ecomerce/api/lista-deseos/productos/${productId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        updateWishlistButton(false);
                        if (window.showToast) {
                            window.showToast('Producto removido de favoritos', 'success');
                        }
                    }
                } else {
                    const response = await fetch('/ecomerce/api/lista-deseos/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ producto_id: productId })
                    });

                    if (response.ok) {
                        updateWishlistButton(true);
                        if (window.showToast) {
                            window.showToast('Producto agregado a favoritos', 'success');
                        }
                    } else if (response.status === 401) {
                        alert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente');
                        window.location.href = '/ecomerce/login?redirect=' + encodeURIComponent(window.location.pathname);
                    }
                }
            } catch (error) {
                console.error('Error al toggle wishlist:', error);
                alert('Error de conexi√≥n. Intenta nuevamente');
            }
        }

        // Agregar event listener al bot√≥n de wishlist
        document.getElementById('wishlist-btn')?.addEventListener('click', toggleWishlist);

        async function loadProductDetails(productId) {
            try {
                document.getElementById('loading').classList.remove('hidden');

                // Intentar obtener el producto desde la API p√∫blica
                const response = await fetch(`/ecomerce/api/productos/publicos?limit=1000`);
                if (!response.ok) throw new Error('Error al cargar productos');

                const products = await response.json();
                const product = products.find(p => p.id === productId);
                
                if (!product) throw new Error('Producto no encontrado');
                
                // Guardar el producto en la variable global
                currentProduct = product;

                // Actualizar informaci√≥n del producto
                document.getElementById('product-name').textContent = product.nombre || 'Sin nombre';
                document.getElementById('product-description').textContent = product.descripcion || 'Sin descripci√≥n';
                document.getElementById('product-price').textContent = `$${(product.precio || 0).toLocaleString('es-ES')}`;
                document.getElementById('product-stock').textContent = `Stock: Disponible`;
                document.getElementById('product-code').textContent = product.codigo || '-';
                document.getElementById('product-category').textContent = product.id_categoria || '-';
                document.getElementById('product-active').textContent = product.active ? 'Activo' : 'Inactivo';

                if (product.imagen_url) {
                    document.getElementById('product-image').src = product.imagen_url;
                }

                // Cargar y mostrar variantes
                if (product.variantes && product.variantes.length > 0) {
                    loadProductVariants(product.variantes);
                }

            } catch (error) {
                console.error('Error loading product:', error);
                document.getElementById('error').classList.remove('hidden');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function loadProductVariants(variantes) {
            if (!variantes || variantes.length === 0) {
                document.getElementById('variants-container').classList.add('hidden');
                return;
            }

            const container = document.getElementById('variants-container');
            const variantsList = document.getElementById('variants-list');
            
            // Obtener campos √∫nicos de las variantes (excluyendo algunos campos)
            const excludedFields = ['precio_adicional', 'stock', 'imagen_url', 'active', 'product_id', '_id', 'id'];
            const variantFields = new Set();
            
            variantes.forEach(variant => {
                Object.keys(variant).forEach(key => {
                    if (!excludedFields.includes(key) && variant[key] !== null && variant[key] !== undefined && variant[key] !== '') {
                        variantFields.add(key);
                    }
                });
            });

            if (variantFields.size === 0) {
                container.classList.add('hidden');
                return;
            }

            // Crear selectores para cada campo de variante
            const sortedFields = Array.from(variantFields).sort((a, b) => {
                const order = ['color', 'tipo'];
                const aIndex = order.indexOf(a);
                const bIndex = order.indexOf(b);
                if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                if (aIndex !== -1) return -1;
                if (bIndex !== -1) return 1;
                return a.localeCompare(b);
            });

            variantsList.innerHTML = sortedFields.map(field => {
                const options = [...new Set(variantes.map(v => v[field]).filter(val => val !== null && val !== undefined && val !== ''))];
                const fieldLabel = field.charAt(0).toUpperCase() + field.slice(1).replace(/_/g, ' ');
                
                return `
                    <div class="variant-option">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ${fieldLabel}:
                        </label>
                        <select class="variant-select w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300" data-field="${field}">
                            <option value="">Selecciona una opci√≥n</option>
                            ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                    </div>
                `;
            }).join('');

            // Agregar event listeners a los selectores con animaciones
            document.querySelectorAll('.variant-select').forEach(select => {
                select.addEventListener('change', function() {
                    updateVariantPrice();
                    
                    // Animar el select que cambi√≥
                    const variantOption = this.closest('.variant-option');
                    if (variantOption) {
                        variantOption.classList.remove('variant-change-highlight');
                        void variantOption.offsetWidth;
                        variantOption.classList.add('variant-change-highlight');
                    }
                });
            });

            container.classList.remove('hidden');
        }

        function updateVariantPrice() {
            const selectedVariant = getSelectedVariant();
            if (selectedVariant) {
                const priceElement = document.getElementById('product-price');
                const newPrice = currentProduct.precio + (selectedVariant.precio_adicional || 0);
                
                // Agregar animaci√≥n al cambiar precio
                priceElement.classList.remove('price-update');
                void priceElement.offsetWidth; // Trigger reflow para reiniciar animaci√≥n
                priceElement.classList.add('price-update');
                
                // Cambiar el texto despu√©s de un peque√±o delay
                setTimeout(() => {
                    priceElement.textContent = `$${newPrice.toLocaleString('es-ES')}`;
                }, 200);
            }
        }

        function getSelectedVariant() {
            if (!currentProduct || !currentProduct.variantes) return null;

            const selects = document.querySelectorAll('.variant-select');
            const selectedValues = {};
            let allSelected = true;

            selects.forEach(select => {
                const field = select.getAttribute('data-field');
                const value = select.value;
                if (value) {
                    selectedValues[field] = value;
                } else {
                    allSelected = false;
                }
            });

            if (!allSelected) return null;

            // Buscar la variante que coincida con todos los valores seleccionados
            return currentProduct.variantes.find(variant => {
                return Object.entries(selectedValues).every(([key, value]) => variant[key] === value);
            });
        }

        async function loadProductReviews(productId) {
            try {
                const response = await fetch(`/ecomerce/api/resenas/producto/${productId}`);
                const reviews = await response.json();

                const container = document.getElementById('reviews-container');
                if (reviews.length === 0) {
                    container.innerHTML = '<p class="text-gray-600">No hay rese√±as para este producto a√∫n.</p>';
                    return;
                }

                container.innerHTML = reviews.map(review => `
                    <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                <div class="flex text-yellow-400">
                                    ${'‚òÖ'.repeat(review.calificacion || 0)}${'‚òÜ'.repeat(5 - (review.calificacion || 0))}
                                </div>
                                <span class="font-medium">${review.usuario || 'An√≥nimo'}</span>
                            </div>
                            <span class="text-sm text-gray-500">${new Date(review.fecha_creacion || Date.now()).toLocaleDateString()}</span>
                        </div>
                        <p class="text-gray-700">${review.comentario || ''}</p>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading reviews:', error);
                document.getElementById('reviews-container').innerHTML = '<p class="text-red-600">Error al cargar las rese√±as.</p>';
            }
        }

        // Add to cart functionality
        document.getElementById('add-to-cart-btn').addEventListener('click', async function() {
            if (!currentProduct) {
                alert('Error: No se ha cargado la informaci√≥n del producto');
                return;
            }
            
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const productIdToAdd = currentProduct.id || currentProduct._id || productId;
            
            // Verificar si el producto tiene variantes
            const hasVariants = currentProduct.variantes && currentProduct.variantes.length > 0;
            const selects = document.querySelectorAll('.variant-select');
            
            console.log('üîç Verificando variantes:', {
                hasVariants,
                variantsCount: currentProduct.variantes?.length || 0,
                selectsCount: selects.length
            });
            
            // VALIDACI√ìN: Si tiene variantes, debe seleccionar todas
            if (hasVariants && selects.length > 0) {
                let allSelected = true;
                const missingFields = [];
                
                selects.forEach(select => {
                    if (!select.value) {
                        allSelected = false;
                        const field = select.getAttribute('data-field');
                        const label = field.charAt(0).toUpperCase() + field.slice(1);
                        missingFields.push(label);
                    }
                });
                
                if (!allSelected) {
                    alert(`‚ö†Ô∏è Por favor selecciona: ${missingFields.join(', ')}\n\nEste producto tiene variantes y debes seleccionar todas las opciones antes de agregarlo al carrito.`);
                    // Resaltar los selectores vac√≠os
                    selects.forEach(select => {
                        if (!select.value) {
                            select.style.borderColor = '#ef4444';
                            select.style.borderWidth = '2px';
                            setTimeout(() => {
                                select.style.borderColor = '';
                                select.style.borderWidth = '';
                            }, 3000);
                        }
                    });
                    return;
                }
            }
            
            // Obtener la variante seleccionada
            const selectedVariant = getSelectedVariant();
            let variantData = null;
            let price = currentProduct.precio || 0;
            
            // Si hay variante seleccionada, incluir sus datos
            if (selectedVariant) {
                variantData = {};
                // Copiar todos los campos de la variante excepto precio_adicional y campos internos
                Object.keys(selectedVariant).forEach(key => {
                    if (key !== 'precio_adicional' && key !== '_id' && key !== 'id' && key !== 'stock' && key !== 'imagen_url' && key !== 'active' && key !== 'product_id') {
                        variantData[key] = selectedVariant[key];
                    }
                });
                // Ajustar el precio con el adicional de la variante
                price = price + (selectedVariant.precio_adicional || 0);
                
                console.log('‚úÖ Variante seleccionada:', {
                    selectedVariant,
                    variantData,
                    precioBase: currentProduct.precio,
                    precioAdicional: selectedVariant.precio_adicional,
                    precioFinal: price
                });
            } else if (hasVariants) {
                console.log('‚ÑπÔ∏è Producto tiene variantes pero ninguna seleccionada');
            } else {
                console.log('‚ÑπÔ∏è Producto sin variantes');
            }
            
            console.log('üõí Agregando producto al carrito desde detalle:', {
                productId: productIdToAdd,
                quantity,
                price,
                productName: currentProduct.nombre,
                variantData: variantData,
                hasVariants: hasVariants
            });
            
            // Usar la funci√≥n global addToCart del carrito.js con variantes
            if (window.cart && window.cart.addProduct) {
                try {
                    const success = await window.cart.addProduct(productIdToAdd, quantity, price, variantData);
                    if (success) {
                        const variantInfo = variantData ? ` con ${Object.entries(variantData).map(([k,v]) => `${k}: ${v}`).join(', ')}` : ' sin variante';
                        console.log(`‚úÖ Producto agregado exitosamente al carrito${variantInfo}`);
                        // Opcionalmente, mostrar un toast de √©xito
                        if (window.showToast) {
                            const variantText = variantData ? ` (${Object.values(variantData).join(', ')})` : '';
                            window.showToast(`Producto agregado al carrito${variantText}`, 'success');
                        }
                    } else {
                        console.error('‚ùå Error al agregar producto al carrito');
                        alert('Error al agregar el producto al carrito');
                    }
                } catch (error) {
                    console.error('‚ùå Error al agregar producto:', error);
                    alert('Error al agregar el producto al carrito');
                }
            } else {
                console.error('‚ùå Sistema de carrito no disponible');
                alert('Error: Sistema de carrito no disponible');
            }
        });
    </script>

{% endblock %}

{% block extra_scripts %}
<script src="/static/ecomerce/carrito.js"></script>
<script src="/static/ecomerce/wishlist_counter.js"></script>
{% endblock %}