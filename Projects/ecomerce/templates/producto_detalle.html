<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Producto - Ecommerce Store</title>
    <script src="/static/tailwind.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="/static/config.js"></script>
    <script src="/static/ecomerce/cart_button.js"></script>
    <style>
        :root {
            --ecommerce-blue: #00bfff;
            --ecommerce-dark: #1a1a1a;
            --ecommerce-gray: #f8f9fa;
            --ecommerce-light: #ffffff;
            --ecommerce-text: #333333;
            --ecommerce-text-light: #666666;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--ecommerce-gray);
            color: var(--ecommerce-text);
            line-height: 1.6;
        }
        .product-image {
            max-width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: 12px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--ecommerce-blue) 0%, #0099cc 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 191, 255, 0.3);
        }
        .btn-secondary {
            background: var(--ecommerce-light);
            color: var(--ecommerce-blue);
            border: 2px solid var(--ecommerce-blue);
            border-radius: 12px;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        .btn-secondary:hover {
            background: var(--ecommerce-blue);
            color: white;
        }
        .quantity-input {
            width: 80px;
            text-align: center;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.5rem;
            font-size: 1rem;
        }
        /* Cart Sidebar */
        .cart-sidebar {
            background: var(--ecommerce-light);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
        }
        .cart-overlay {
            background: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <a href="/" class="flex items-center space-x-2 text-gray-800 hover:text-blue-600 transition-colors">
                        <img alt="Logo" class="h-8 w-auto" src="/static/img/logo.png" onerror="this.onerror=null; this.src='/static/img/logo.png'"/>
                        <span class="font-bold text-lg">Detalle del Producto</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-gray-600 hover:text-blue-600 flex items-center space-x-2 transition-colors">
                        <i class="fas fa-home"></i>
                        <span>Inicio</span>
                    </a>
                    <a href="/ecomerce/productos/tienda" class="text-gray-600 hover:text-blue-600 flex items-center space-x-2 transition-colors">
                        <i class="fas fa-store"></i>
                        <span>Productos</span>
                    </a>
                    <!-- Usuario no autenticado -->
                    <div id="auth-buttons" class="flex items-center space-x-2">
                        <a href="/ecomerce/login" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2">
                            <i class="fas fa-sign-in-alt"></i>
                            <span>Iniciar Sesi√≥n</span>
                        </a>
                        <a href="/ecomerce/register" class="bg-white text-blue-600 border-2 border-blue-600 hover:bg-blue-600 hover:text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2">
                            <i class="fas fa-user-plus"></i>
                            <span>Registrarse</span>
                        </a>
                    </div>
                    <!-- Usuario autenticado -->
                    <div id="user-info" class="flex items-center space-x-2 hidden relative">
                        <div class="relative">
                            <button id="user-dropdown-btn" class="flex items-center space-x-2 text-gray-600 hover:text-blue-600 px-3 py-2 rounded-lg transition-colors">
                                <i class="fas fa-user-circle"></i>
                                <span id="user-greeting">Hola, Usuario</span>
                                <i class="fas fa-chevron-down text-xs"></i>
                            </button>
                            <!-- Dropdown Menu -->
                            <div id="user-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 hidden">
                                <div class="py-1">
                                    <a href="/ecomerce/perfil" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                        <i class="fas fa-heart text-red-500 mr-2"></i>
                                        Mis Favoritos
                                    </a>
                                    <a href="/ecomerce/usuarios/perfil" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                        <i class="fas fa-user mr-2"></i>
                                        Mi Perfil
                                    </a>
                                    <div class="border-t border-gray-200"></div>
                                    <button onclick="logout()" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                        <i class="fas fa-sign-out-alt mr-2"></i>
                                        Salir
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Bot√≥n de Favoritos -->
                    <a href="/ecomerce/perfil" class="text-gray-600 hover:text-red-500 px-3 py-2 rounded-lg transition-colors relative hidden" id="wishlist-nav-button" title="Mis Favoritos">
                        <i class="fas fa-heart"></i>
                        <span class="ml-1 hidden md:inline">Favoritos</span>
                        <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden" id="wishlist-count">0</span>
                    </a>
                    <button class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-lg transition-colors relative" id="cart-button" onclick="toggleCart()">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="ml-1 hidden md:inline">Carrito</span>
                        <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center" id="cart-count">0</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    <!-- Toast Notifications -->
    <div id="toast-container"></div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Product Image -->
            <div>
                <img id="product-image" src="/static/img/logo.png" alt="Producto" class="product-image w-full">
            </div>

            <!-- Product Info -->
            <div class="space-y-6">
                <div>
                    <h1 id="product-name" class="text-3xl font-bold text-gray-900">Cargando producto...</h1>
                    <p id="product-description" class="text-gray-600 mt-2">Descripci√≥n del producto</p>
                </div>

                <div>
                    <p class="text-3xl font-bold text-blue-600" id="product-price">$0.00</p>
                    <p class="text-sm text-gray-500" id="product-stock">Stock disponible</p>
                </div>

                <!-- Add to Cart -->
                <div class="space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="text-gray-700 font-medium">Cantidad:</label>
                        <input type="number" id="quantity" value="1" min="1" class="quantity-input">
                    </div>

                    <div class="flex gap-4">
                        <button id="add-to-cart-btn" class="btn-primary flex-1">
                            <i class="fas fa-cart-plus"></i>
                            Agregar al Carrito
                        </button>
                        <button id="wishlist-btn" class="bg-white text-gray-600 hover:text-red-500 border-2 border-gray-300 hover:border-red-500 rounded-lg px-6 py-3 transition-all duration-200 flex items-center justify-center" title="Agregar a favoritos">
                            <i class="far fa-heart text-2xl"></i>
                        </button>
                    </div>
                    <a href="/ecomerce/productos/tienda" class="btn-secondary w-full justify-center">
                        <i class="fas fa-arrow-left"></i>
                        Volver a la Tienda
                    </a>
                </div>

                <!-- Product Details -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4">Detalles del Producto</h3>
                    <div class="space-y-2">
                        <p><strong>C√≥digo:</strong> <span id="product-code">-</span></p>
                        <p><strong>Categor√≠a:</strong> <span id="product-category">-</span></p>
                        <p><strong>Estado:</strong> <span id="product-active">-</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="mt-12 bg-white p-6 rounded-lg shadow">
            <h3 class="text-xl font-semibold mb-6">Rese√±as de Clientes</h3>
            <div id="reviews-container">
                <p class="text-gray-600">Cargando rese√±as...</p>
            </div>
        </div>

        <!-- Loading/Error Messages -->
        <div id="loading" class="text-center py-8 hidden">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            <p class="mt-2 text-gray-600">Cargando producto...</p>
        </div>

        <div id="error" class="text-center py-8 bg-red-50 border border-red-200 rounded-lg hidden">
            <p class="text-red-600">Error al cargar el producto. Por favor, intenta nuevamente.</p>
        </div>
    </main>

    <!-- Cart Sidebar -->
    <div id="cart-sidebar" class="fixed right-0 top-0 h-full w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 cart-sidebar">
        <div class="flex flex-col h-full">
            <!-- Cart Header -->
            <div class="flex items-center justify-between p-6 border-b bg-gray-50">
                <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-shopping-cart mr-2 text-blue-600"></i>
                    Carrito de Compras
                </h2>
                <button onclick="toggleCart()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Cart Items -->
            <div id="cart-items" class="flex-1 overflow-y-auto p-6 space-y-4">
                <!-- Cart items will be populated here -->
            </div>

            <!-- Empty Cart Message -->
            <div id="empty-cart" class="hidden flex-1 flex items-center justify-center p-6">
                <div class="text-center">
                    <i class="fas fa-shopping-cart text-gray-300 text-6xl mb-4"></i>
                    <p class="text-gray-500 text-lg">Tu carrito est√° vac√≠o</p>
                    <p class="text-gray-400 text-sm mt-2">Agrega productos para comenzar</p>
                </div>
            </div>

            <!-- Cart Footer -->
            <div id="cart-footer" class="border-t bg-gray-50 p-6">
                <div class="space-y-4">
                    <div class="flex justify-between items-center text-lg font-semibold">
                        <span>Total:</span>
                        <span id="cart-total" class="text-blue-600">$0.00</span>
                    </div>
                    <button onclick="window.location.href='/ecomerce/checkout'" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition-colors font-medium">
                        <i class="fas fa-credit-card mr-2"></i>
                        Proceder al Pago
                    </button>
                    <a href="/ecomerce/carrito" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-4 rounded-lg transition-colors font-medium text-center block">
                        <i class="fas fa-eye mr-2"></i>
                        Ver Carrito Completo
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Overlay -->
    <div id="cart-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden cart-overlay" onclick="toggleCart()"></div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <p>&copy; 2025 Tienda Online. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
        // Get product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = window.location.pathname.split('/').pop();
        
        // Variable global para almacenar los datos del producto
        let currentProduct = null;

        // Initialize the product detail page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Product detail page loaded for product:', productId);
            loadProductDetails(productId);
            loadProductReviews(productId);
            checkWishlistStatus();
        });

        async function checkWishlistStatus() {
            // Obtener token desde authManager o storage
            let token = null;
            if (window.authManager && typeof window.authManager.getToken === 'function') {
                token = window.authManager.getToken();
            }
            if (!token) {
                token = sessionStorage.getItem('ecommerce_token') ||
                       localStorage.getItem('token') ||
                       localStorage.getItem('access_token');
            }
            if (!token) return;

            try {
                // Obtener toda la lista de deseos
                const response = await fetch('/ecomerce/api/lista-deseos/', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const wishlistProductIds = new Set(
                        (data.productos || []).map(item => item.producto?.id || item.id_producto)
                    );
                    const inWishlist = wishlistProductIds.has(productId);
                    updateWishlistButton(inWishlist);
                }
                // Si falla, simplemente no actualizar el bot√≥n
            } catch (error) {
                // Error de red - ignorar silenciosamente
            }
        }

        function updateWishlistButton(inWishlist) {
            const button = document.getElementById('wishlist-btn');
            const icon = button.querySelector('i');
            
            // Agregar animaci√≥n de rebote
            button.style.transition = 'transform 0.2s ease';
            button.style.transform = 'scale(1.15)';
            setTimeout(() => {
                button.style.transform = 'scale(1)';
            }, 200);
            
            if (inWishlist) {
                button.classList.add('in-wishlist');
                button.classList.remove('text-gray-600', 'border-gray-300');
                button.classList.add('text-red-500', 'border-red-500', 'bg-red-50');
                icon.classList.remove('far');
                icon.classList.add('fas');
                button.setAttribute('title', 'Remover de favoritos');
            } else {
                button.classList.remove('in-wishlist', 'text-red-500', 'border-red-500', 'bg-red-50');
                button.classList.add('text-gray-600', 'border-gray-300');
                icon.classList.remove('fas');
                icon.classList.add('far');
                button.setAttribute('title', 'Agregar a favoritos');
            }
        }

        async function toggleWishlist() {
            // Obtener token desde authManager o storage
            let token = null;
            if (window.authManager && typeof window.authManager.getToken === 'function') {
                token = window.authManager.getToken();
            }
            if (!token) {
                token = sessionStorage.getItem('ecommerce_token') ||
                       localStorage.getItem('token') ||
                       localStorage.getItem('access_token');
            }
            
            if (!token) {
                alert('Debes iniciar sesi√≥n para agregar favoritos');
                window.location.href = '/ecomerce/login?redirect=' + encodeURIComponent(window.location.pathname);
                return;
            }

            const button = document.getElementById('wishlist-btn');
            const isInWishlist = button.classList.contains('in-wishlist');
            
            try {
                if (isInWishlist) {
                    const response = await fetch(`/ecomerce/api/lista-deseos/productos/${productId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        updateWishlistButton(false);
                        if (window.showToast) {
                            window.showToast('Producto removido de favoritos', 'success');
                        }
                    }
                } else {
                    const response = await fetch('/ecomerce/api/lista-deseos/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ id_producto: productId })
                    });

                    if (response.ok) {
                        updateWishlistButton(true);
                        if (window.showToast) {
                            window.showToast('Producto agregado a favoritos', 'success');
                        }
                    } else if (response.status === 401) {
                        alert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente');
                        window.location.href = '/ecomerce/login?redirect=' + encodeURIComponent(window.location.pathname);
                    }
                }
            } catch (error) {
                console.error('Error al toggle wishlist:', error);
                alert('Error de conexi√≥n. Intenta nuevamente');
            }
        }

        // Agregar event listener al bot√≥n de wishlist
        document.getElementById('wishlist-btn')?.addEventListener('click', toggleWishlist);

        async function loadProductDetails(productId) {
            try {
                document.getElementById('loading').classList.remove('hidden');

                const response = await fetch(`/ecomerce/api/productos/${productId}`);
                if (!response.ok) throw new Error('Producto no encontrado');

                const product = await response.json();
                
                // Guardar el producto en la variable global
                currentProduct = product;

                // Update product information
                document.getElementById('product-name').textContent = product.nombre || 'Sin nombre';
                document.getElementById('product-description').textContent = product.descripcion || 'Sin descripci√≥n';
                document.getElementById('product-price').textContent = `$${product.precio || 0}`;
                document.getElementById('product-stock').textContent = `Stock: ${product.stock || 0}`;
                document.getElementById('product-code').textContent = product.codigo || '-';
                document.getElementById('product-category').textContent = product.categoria || '-';
                document.getElementById('product-active').textContent = product.active ? 'Activo' : 'Inactivo';

                if (product.imagen_url) {
                    document.getElementById('product-image').src = product.imagen_url;
                }

            } catch (error) {
                console.error('Error loading product:', error);
                document.getElementById('error').classList.remove('hidden');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        async function loadProductReviews(productId) {
            try {
                const response = await fetch(`/ecomerce/api/resenas/producto/${productId}`);
                const reviews = await response.json();

                const container = document.getElementById('reviews-container');
                if (reviews.length === 0) {
                    container.innerHTML = '<p class="text-gray-600">No hay rese√±as para este producto a√∫n.</p>';
                    return;
                }

                container.innerHTML = reviews.map(review => `
                    <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                <div class="flex text-yellow-400">
                                    ${'‚òÖ'.repeat(review.calificacion || 0)}${'‚òÜ'.repeat(5 - (review.calificacion || 0))}
                                </div>
                                <span class="font-medium">${review.usuario || 'An√≥nimo'}</span>
                            </div>
                            <span class="text-sm text-gray-500">${new Date(review.fecha_creacion || Date.now()).toLocaleDateString()}</span>
                        </div>
                        <p class="text-gray-700">${review.comentario || ''}</p>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading reviews:', error);
                document.getElementById('reviews-container').innerHTML = '<p class="text-red-600">Error al cargar las rese√±as.</p>';
            }
        }

        // Add to cart functionality
        document.getElementById('add-to-cart-btn').addEventListener('click', async function() {
            if (!currentProduct) {
                alert('Error: No se ha cargado la informaci√≥n del producto');
                return;
            }
            
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const price = currentProduct.precio || 0;
            const productIdToAdd = currentProduct.id || currentProduct._id || productId;
            
            console.log('üõí Agregando producto al carrito desde detalle:', {
                productId: productIdToAdd,
                quantity,
                price,
                productName: currentProduct.nombre
            });
            
            // Usar la funci√≥n global addToCart del carrito.js
            if (window.addToCart) {
                try {
                    const success = await window.addToCart(productIdToAdd, quantity, price);
                    if (success) {
                        console.log('‚úÖ Producto agregado exitosamente al carrito');
                        // Opcionalmente, mostrar un toast de √©xito
                        if (window.showToast) {
                            window.showToast('Producto agregado al carrito', 'success');
                        }
                    } else {
                        console.error('‚ùå Error al agregar producto al carrito');
                        alert('Error al agregar el producto al carrito');
                    }
                } catch (error) {
                    console.error('‚ùå Error al agregar producto:', error);
                    alert('Error al agregar el producto al carrito');
                }
            } else {
                console.error('‚ùå Funci√≥n addToCart no disponible');
                alert('Error: Sistema de carrito no disponible');
            }
        });
    </script>

    <!-- Scripts de autenticaci√≥n y carrito -->
    <script src="/static/ecomerce/auth.js"></script>
    <script src="/static/ecomerce/carrito.js"></script>
    <script src="/static/ecomerce/wishlist_counter.js"></script>
</body>
</html>