<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago Fallido</title>
    <script src="/static/tailwind.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-times-circle text-red-400 text-3xl"></i>
                </div>
                <div class="ml-4">
                    <h1 class="text-xl font-semibold text-red-800">Pago No Completado</h1>
                    <p class="text-red-700">El pago no pudo ser procesado. Revisa los detalles abajo.</p>
                </div>
            </div>
        </div>

        <!-- Información del Error -->
        <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Información del Error</h2>
            <div id="error-info" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Los datos se cargarán dinámicamente -->
            </div>
        </div>

        <!-- Parámetros GET Recibidos -->
        <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Parámetros Recibidos</h2>
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-medium text-gray-700 mb-2">URL Actual:</h3>
                <code id="current-url" class="text-sm text-gray-600 break-all"></code>
            </div>
            <div class="mt-4">
                <h3 class="font-medium text-gray-700 mb-2">Parámetros GET:</h3>
                <pre id="get-params" class="bg-gray-100 p-3 rounded text-sm overflow-x-auto"></pre>
            </div>
        </div>

        <!-- Información de Depuración -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Información de Depuración</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">User Agent:</h3>
                    <code id="user-agent" class="text-sm text-gray-600 break-all"></code>
                </div>
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">Timestamp:</h3>
                    <code id="timestamp" class="text-sm text-gray-600"></code>
                </div>
            </div>
        </div>

        <!-- Botones de Acción -->
        <div class="mt-6 flex flex-col sm:flex-row gap-4">
            <button onclick="retryPayment()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-redo mr-2"></i>Intentar de Nuevo
            </button>
            <a href="/ecomerce" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors text-center">
                <i class="fas fa-home mr-2"></i>Ir al Inicio
            </a>
            <button onclick="window.history.back()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Volver
            </button>
        </div>
    </div>

    <script>
        // ============================================================================
        // FUNCIONES DE UTILIDAD
        // ============================================================================

        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ============================================================================
        // ANÁLISIS DE PARÁMETROS
        // ============================================================================

        function updateDebugInfo() {
            // URL actual
            document.getElementById('current-url').textContent = window.location.href;

            // Parámetros GET
            const urlParams = new URLSearchParams(window.location.search);
            const params = {};
            for (let [key, value] of urlParams) {
                params[key] = value;
            }
            document.getElementById('get-params').textContent = JSON.stringify(params, null, 2);

            // User Agent
            document.getElementById('user-agent').textContent = navigator.userAgent;

            // Timestamp
            document.getElementById('timestamp').textContent = new Date().toISOString();

            // Mostrar información adicional si hay parámetros
            if (urlParams.toString()) {
                console.log('=== PARÁMETROS RECIBIDOS (FAILURE) ===');
                console.log('URL completa:', window.location.href);
                console.log('Parámetros:', params);
                console.log('Timestamp:', new Date().toISOString());
                console.log('=====================================');

                // Mostrar notificación
                showToast('Parámetros de error recibidos - revisa la consola', 'warning');

                // Procesar parámetros específicos
                processPaymentErrorParams(params);
            }

            return params;
        }

        function processPaymentErrorParams(params) {
            const errorInfo = document.getElementById('error-info');

            // Parámetros importantes de error
            const errorParams = {
                'collection_id': { label: 'ID de Cobro', icon: 'fa-credit-card' },
                'collection_status': { label: 'Estado del Cobro', icon: 'fa-info-circle' },
                'payment_id': { label: 'ID de Pago', icon: 'fa-hashtag' },
                'status': { label: 'Estado', icon: 'fa-times-circle' },
                'external_reference': { label: 'Referencia Externa', icon: 'fa-link' },
                'payment_type': { label: 'Tipo de Pago', icon: 'fa-money-bill' },
                'merchant_order_id': { label: 'ID Orden Mercante', icon: 'fa-shopping-cart' },
                'preference_id': { label: 'ID Preferencia', icon: 'fa-cog' },
                'site_id': { label: 'ID Sitio', icon: 'fa-globe' },
                'processing_mode': { label: 'Modo Procesamiento', icon: 'fa-cogs' },
                'merchant_account_id': { label: 'ID Cuenta Mercante', icon: 'fa-user' }
            };

            let html = '';

            // Mostrar estado de error
            if (params.collection_status) {
                const statusMessages = {
                    'rejected': 'Pago rechazado',
                    'cancelled': 'Pago cancelado',
                    'pending': 'Pago pendiente',
                    'failure': 'Error en el pago'
                };

                const statusMessage = statusMessages[params.collection_status] || 'Estado desconocido';
                const statusColor = params.collection_status === 'rejected' || params.collection_status === 'cancelled' ?
                    'text-red-600' : 'text-yellow-600';

                html += `
                    <div class="bg-red-50 p-4 rounded-lg md:col-span-2">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                            <span class="font-medium text-red-800">Estado del Pago</span>
                        </div>
                        <span class="text-lg ${statusColor} font-semibold">${statusMessage}</span>
                        <p class="text-sm text-gray-600 mt-1">Revisa los detalles técnicos abajo para más información.</p>
                    </div>
                `;
            }

            // Mostrar parámetros importantes
            for (const [key, config] of Object.entries(errorParams)) {
                if (params[key]) {
                    const statusClass = key === 'collection_status' || key === 'status' ?
                        (params[key] === 'approved' ? 'text-green-600' : params[key] === 'rejected' || params[key] === 'cancelled' ? 'text-red-600' : 'text-yellow-600') : 'text-gray-800';

                    html += `
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <div class="flex items-center mb-1">
                                <i class="fas ${config.icon} text-blue-500 mr-2"></i>
                                <span class="font-medium text-gray-700">${config.label}</span>
                            </div>
                            <span class="text-sm ${statusClass} font-mono">${params[key]}</span>
                        </div>
                    `;
                }
            }

            // Mostrar otros parámetros
            const otherParams = Object.keys(params).filter(key => !errorParams[key]);
            if (otherParams.length > 0) {
                html += `
                    <div class="bg-gray-50 p-3 rounded-lg md:col-span-2">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-list text-gray-500 mr-2"></i>
                            <span class="font-medium text-gray-700">Otros Parámetros</span>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                `;

                otherParams.forEach(key => {
                    html += `
                        <div class="text-xs">
                            <span class="font-medium text-gray-600">${key}:</span>
                            <span class="text-gray-800 font-mono ml-1">${params[key]}</span>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            errorInfo.innerHTML = html || '<p class="text-gray-500">No se encontraron parámetros de error</p>';
        }

        // ============================================================================
        // FUNCIONES DE ACCIÓN
        // ============================================================================

        function retryPayment() {
            // Intentar recrear el pago
            console.log('Intentando recrear el pago...');

            // Redirigir al checkout
            window.location.href = '/ecomerce/checkout';
        }

        // ============================================================================
        // INICIALIZACIÓN
        // ============================================================================

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('=== PÁGINA DE ERROR MERCADOPAGO ===');

            // Actualizar información de depuración
            const params = updateDebugInfo();

            // Si hay parámetros, intentar obtener información adicional del pedido
            if (params.external_reference) {
                try {
                    const response = await fetch(`/ecomerce/pedidos/id/${params.external_reference}`);
                    if (response.ok) {
                        const pedido = await response.json();
                        console.log('Información del pedido:', pedido);

                        // Mostrar información adicional del pedido
                        showToast(`Pedido #${pedido.id} - Estado: ${pedido.estado}`, 'warning');
                    }
                } catch (error) {
                    console.warn('Error obteniendo información del pedido:', error);
                }
            }

            // Función global para diagnóstico
            window.diagnoseFailurePage = function() {
                console.log('=== DIAGNÓSTICO PÁGINA FAILURE ===');
                console.log('URL:', window.location.href);
                console.log('Parámetros:', params);
                console.log('Timestamp:', new Date().toISOString());
                console.log('================================');
                return params;
            };
        });
    </script>
</body>
</html>
